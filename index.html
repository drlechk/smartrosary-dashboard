<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<title>SmartRosary — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header-with-lang">
    <h1 id="titleTxt">SmartRosary — Dashboard</h1>
    <select id="langSelect">
      <option value="pl">PL</option>
      <option value="en">EN</option>
      <option value="de">DE</option>
    </select>
  </header>

  <div class="toolbar-wrap">
    <div class="toolbar">
      <button id="connectBtn">Connect</button>
      <button id="refreshBtn" disabled>Refresh</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>

  <div id="status">Not connected.</div>

  <section class="wrap">
    <div class="grid">
      <div class="card">
        <h3 id="overviewTitle">Overview</h3>
        <div class="kpis" style="grid-template-columns:repeat(3,1fr);">


          <div class="kpi"><div class="label" id="lblBeads">Beads</div><div class="value" id="kpiBeads">—</div></div>
          <div class="kpi"><div class="label" id="lblDecades">Decades</div><div class="value" id="kpiDecades">—</div></div>
          <div class="kpi"><div class="label" id="lblRosaries">Rosaries</div><div class="value" id="kpiRosaries">—</div></div>
          <div class="kpi"><div class="label" id="lblChaplets">Chaplets</div><div class="value" id="kpiChaplets">—</div></div>
        </div>
        <div class="flex" style="margin-top:12px;">
          <span class="pill" id="pillDevice"><span id="lblDevice">Device</span>: <span id="valDevice">—</span></span>
          <span class="pill" id="pillFW"><span id="lblFW">FW</span>: <span id="valFW">—</span></span>
          <span class="pill" id="pillLastMystery"><span id="lblLastMystery">Last mystery</span>: <span id="valLastMystery">—</span></span>
        </div>
        <p class="smallnote" id="bkNote"></p>
        <h3 id="lblBackupRestore">Backup & Restore</h3>
        <div class="row">
          <button id="backupBtn"  disabled>Download</button>
          <input type="file" id="restoreFile" accept="application/json" style="display:none">
          <button id="restoreBtn" disabled>Restore</button>
          <button id="resetBtn" disabled>Reset Statistics</button>
          <progress id="restoreProg" max="100" value="0" hidden></progress>
        </div>
      </div>

      <div class="card">
        <h3 id="settingsTitle">Settings</h3>
        <div class="settings-list">
          <div class="setting">
            <div class="meta">
              <span class="title" id="lblPreset">Start with preset mystery</span>
              <span class="desc"  id="descPreset">Begin rosary on a chosen set (disables autosave).</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="swPreset" disabled>
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting">
            <div class="meta">
              <span class="title" id="lblAutosave">Autosave last state</span>
              <span class="desc"  id="descAutosave">Continue where you left off.</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="swAutosave" disabled>
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting">
            <div class="meta">
              <span class="title" id="lblHaptic">Haptic feedback</span>
              <span class="desc"  id="descHaptic">Vibration on key/bead events.</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="swHaptic" disabled>
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="meta">
              <span class="title" id="lblDispBright">Display brightness</span>
              <span class="desc"  id="descDispBright">Adjust screen backlight (0–100).</span>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <input id="slDispBright" type="range" min="0" max="100" step="1" value="0" disabled style="width:140px;">
              <span id="slDispBrightVal" class="pill" style="min-width:48px; text-align:center;">0%</span>
            </div>
          </div>
          <div class="setting" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="meta">
              <span class="title" id="lblWallBright">Wallpaper brightness</span>
              <span class="desc"  id="descWallBright">Adjust background image opacity.</span>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <input type="range" id="slWallBright" min="0" max="100" value="0" disabled style="width:140px" />
              <span id="wallBrightVal" class="pill" style="min-width:48px; text-align:center;">0%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 id="avgTitle">Durations & Averages</h3>
         <div class="kpis" style="grid-template-columns:repeat(3,1fr);">
          <div class="kpi"><div class="label" id="lblAvgBead">Avg bead</div><div class="value" id="kpiAvgBead">—</div></div>
          <div class="kpi"><div class="label" id="lblAvgDecade">Avg decade</div><div class="value" id="kpiAvgDecade">—</div></div>
          <div class="kpi"><div class="label" id="lblAvgRosary">Avg rosary</div><div class="value" id="kpiAvgRosary">—</div></div>
          <div class="kpi"><div class="label" id="lblAvgChaplet">Avg chaplet</div><div class="value" id="kpiAvgChaplet">—</div></div>
        </div>
        <p class="smallnote" id="avgNote">Averages are computed from lifetime device totals.</p>
        <h3 id="totalsTitle">Totals (time)</h3>
        <div class="kpis" style="grid-template-columns:repeat(3,1fr);">
          <div class="kpi"><div class="label" id="lblTrosary">Rosary</div><div class="value" id="totRosary">—</div></div>
          <div class="kpi"><div class="label" id="lblTdecades">Decades</div><div class="value" id="totDecade">—</div></div>
          <div class="kpi"><div class="label" id="lblTbeads">Beads</div><div class="value" id="totBead">—</div></div>
          <div class="kpi"><div class="label" id="lblTchaplet">Chaplet</div><div class="value" id="totChaplet">—</div></div>
        </div>
      </div>

      <div class="card">
        <h3 id="donutTitle">Mystery Sets Breakdown</h3>
        <div class="chart"><canvas id="donutSets"></canvas></div>
        <div class="card-separator"></div>
        <h3 id="partsTitle">Mystery Parts (I–V per set)</h3>
        <div class="chart"><canvas id="partsChart"></canvas></div>
      </div>

      <div class="card history-card" id="historyCard">
        <div class="history-head">
          <h3 id="historyTitle">History</h3>
        </div>
        <div class="row history-row">
          <span id="histParseSummary" class="badge"></span>
          <span id="histDownloadProgress" class="badge pill muted" style="display:none;"></span>
          </div>
        <div class="row history-row overview-history">
          <button id="histDownloadBtn" disabled>Download</button>
          <button id="histRestoreBtn" disabled>Restore</button>
          <span id="histUploadProg" class="badge pill muted" style="display:none;"></span>
        </div>

        <div class="history-columns">
          <section class="history-panel">
            <div class="history-chart-head">
              <div class="row history-chart-controls">
                <label for="histBucketSel" id="histBucketLabel">Bucket:</label>
                <select id="histBucketSel" disabled>
                  <option value="day">Day</option>
                  <option value="week" selected>Week</option>
                  <option value="month">Month</option>
                  <option value="year">Year</option>
                </select>
                <button id="histPrevBtn" disabled>&#x25C0;</button>
                <button id="histNextBtn" disabled>&#x25B6;</button>
                <span id="histPeriodLabel" class="badge"></span>
              </div>
            </div>

            <div class="chart history-chart-wrap">
              <canvas id="histChart"></canvas>
            </div>
            <div id="histLegend" class="history-legend">
              <div class="legend-row" id="histLegendRow1"></div>
              <div class="legend-row" id="histLegendRow2"></div>
            </div>
          </section>
        </div>
      </div>

<!-- Wallpaper / SPIFFS Explorer -->
<div class="card wp-muted" id="wpCard">
  <div class="wp-header">
    <h3 id="wpTitle">Wallpaper</h3>
  </div>

  <!-- Files table -->
<div id="wpFilesPanel" class="wp-files-panel" style="display:none">
  <table class="files">
    <thead>
      <tr>
        <th class="name">File</th>
        <th class="size">Size</th>
        <th class="actions">Actions</th>
      </tr>
    </thead>
    <tbody id="wpFiles"></tbody>
  </table>
</div>
<div id="wpFullMsg" class="muted" style="display:none; margin-top:6px; text-align:center;">
  🚫 Storage full (6/6) — delete one on the device first.
</div>

  <!-- Round preview canvas -->
<div class="wp-canvas-wrap">
  <div class="wp-canvas-shell muted">
    <canvas id="wpCanvas" width="240" height="240"></canvas>
  </div>
</div>

  <!-- Actions -->
<div class="wp-actions">
<button id="wpSelectBtn">Select file…</button>
<input id="wpFileInput" type="file"
       accept=".bin,.rgb565,.565,.raw,image/png,image/jpeg,image/webp"
       style="display:none">

<button id="wpUploadBtn" disabled>Upload</button>
<select id="wpPresetSelect" style="min-width:180px">
  <option value="">— Preset —</option>
</select></br>
<div>
  <button id="wpSaveBinBtn" class="pill" hidden>Save .bin</button>
  <button id="wpSavePngBtn" class="pill" hidden>Save .png</button>
</div>

</div>



  <!-- Progress -->
<div class="wp-progress">
  <progress id="wpProg" max="100" value="0"></progress>
  <div id="wpProgText" class="muted"></div>
</div>
</div>
   

      <div class="card intentions-card" id="intentionsCard">
        <div class="intentions-head">
          <div class="intentions-copy">
            <h3 id="intentionsTitle">Intentions Scheduler</h3>
            <p class="muted" id="intentionsIntro">Review monthly intentions stored on the rosary, adjust start dates and mysteries, then push the schedule back to the device.</p>
          </div>
          <div class="intentions-actions">
            <button id="intentionsLoadBtn" disabled>Load</button>
            <button id="intentionsSaveBtn" disabled>Save Changes</button>
          </div>
        </div>
        <label class="intentions-auto">
          <input type="checkbox" id="intentionsAuto" disabled>
          <span id="intentionsAutoLabel">Enable automatic selection based on start dates</span>
        </label>
        <p class="muted intentions-hint" id="intentionsHint">The active intention is the latest entry whose start date is on or before today (stored at 00:00 UTC).</p>
        <div class="intentions-table-wrap">
          <table id="intentionsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Intention</th>
                <th>Start Date</th>
                <th>Mystery</th>
                <th>Part</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted intentions-empty" id="intentionsEmpty">Connect and load to view intentions stored on the device.</div>
        </div>
      </div>

      <div class="card">
        <h3 id="rcTitle">Remote control</h3>
        <div class="remote-wrap">
          <div class="canvas-shell">
            <canvas id="lvgl_canvas" width="320" height="320" aria-label="Round touch surface"></canvas>
          </div>
          <div class="dpad" role="group" aria-label="LVGL directions + center">
            <div class="empty"></div>
            <button id="btnUp"    aria-label="Top">▲</button>
            <div class="empty"></div>

            <button id="btnLeft"  aria-label="Left">◀</button>
            <button id="btnCenter" class="center" aria-label="Center">●</button>
            <button id="btnRight" aria-label="Right">▶</button>

            <div class="empty"></div>
            <button id="btnDown"  aria-label="Bottom">▼</button>
            <div class="empty"></div>
          </div>
          <div id="rcStatus">Touch + D-pad will activate after connecting.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/patternomaly@1.3.2/dist/patternomaly.min.js"></script>
  <!-- Your modules -->
  <script type="module" src="./js/main.js"></script>
 <script src="https://lib.arvancloud.ir/nosleep/0.9.0/NoSleep.min.js"></script>
<script>
  let wakeLock = null;
  const noSleep = new NoSleep();

  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock released');
        });
        console.log('Wake Lock active');
      } else {
        // Fallback to NoSleep
        noSleep.enable();
        console.log('NoSleep fallback active');
      }
    } catch (err) {
      console.warn('WakeLock error:', err);
      try { noSleep.enable(); } catch {}
    }
  }

  function releaseWakeLock() {
    if (wakeLock) {
      wakeLock.release();
      wakeLock = null;
    }
    try { noSleep.disable(); } catch {}
  }

  // Re-request on visibility change (when user switches tab or screen locks)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      requestWakeLock();
    } else {
      releaseWakeLock();
    }
  });

  // You must call this from a user action (button click, etc.)
  function preventStandby() {
    requestWakeLock();
  }
</script>
</body>
</html>
